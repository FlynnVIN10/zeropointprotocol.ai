name: Weekly Legal & Corporate Compliance Audit

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  weekly-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Audit LICENSE.md consistency
      run: |
        echo "ðŸ” Auditing LICENSE.md consistency..."
        
        # Check corporate entity
        if ! grep -q "Zeropoint Protocol, Inc., a Texas C Corporation with principal offices in Austin, TX" LICENSE.md; then
          echo "âŒ Corporate entity missing from LICENSE.md"
          exit 1
        fi
        
        # Check legal contact
        if ! grep -q "legal@zeropointprotocol.ai" LICENSE.md; then
          echo "âŒ Legal contact missing from LICENSE.md"
          exit 1
        fi
        
        # Check domain
        if ! grep -q "zeropointprotocol.ai" LICENSE.md; then
          echo "âŒ Domain missing from LICENSE.md"
          exit 1
        fi
        
        echo "âœ… LICENSE.md audit passed"
        
    - name: Audit legal documents consistency
      run: |
        echo "ðŸ” Auditing legal documents consistency..."
        
        for doc in ZAA.md CLA.md CONTRIBUTING.md LEGAL.md; do
          if [ ! -f "$doc" ]; then
            echo "âŒ $doc missing"
            exit 1
          fi
          
          # Check corporate entity in each document
          if ! grep -q "Zeropoint Protocol, Inc., a Texas C Corporation with principal offices in Austin, TX" "$doc"; then
            echo "âŒ Corporate entity missing from $doc"
            exit 1
          fi
          
          # Check legal contact in each document
          if ! grep -q "legal@zeropointprotocol.ai" "$doc"; then
            echo "âŒ Legal contact missing from $doc"
            exit 1
          fi
          
          echo "âœ… $doc audit passed"
        done
        
    - name: Audit README.md consistency
      run: |
        echo "ðŸ” Auditing README.md consistency..."
        
        # Check corporate entity
        if ! grep -q "Â© 2025 Zeropoint Protocol, Inc., a Texas C Corporation" README.md; then
          echo "âŒ Corporate entity missing from README.md"
          exit 1
        fi
        
        # Check legal contact
        if ! grep -q "legal@zeropointprotocol.ai" README.md; then
          echo "âŒ Legal contact missing from README.md"
          exit 1
        fi
        
        # Check domain
        if ! grep -q "zeropointprotocol.ai" README.md; then
          echo "âŒ Domain missing from README.md"
          exit 1
        fi
        
        echo "âœ… README.md audit passed"
        
    - name: Audit TypeScript headers
      run: |
        echo "ðŸ” Auditing TypeScript file headers..."
        
        missing_headers=0
        for file in $(find . -name "*.ts" -not -path "./node_modules/*" -not -path "./dist/*"); do
          if ! head -1 "$file" | grep -q "Â© 2025 Zeropoint Protocol, Inc., a Texas C Corporation"; then
            echo "âŒ Missing header in: $file"
            missing_headers=$((missing_headers + 1))
          fi
        done
        
        if [ $missing_headers -gt 0 ]; then
          echo "âŒ Found $missing_headers files with missing headers"
          exit 1
        fi
        
        echo "âœ… All TypeScript files have correct headers"
        
    - name: Audit website documentation (if applicable)
      run: |
        if [ -f "docs/legal.md" ]; then
          echo "ðŸ” Auditing website documentation..."
          
          # Check legal page
          if ! grep -q "Zeropoint Protocol, Inc., a Texas C Corporation with principal offices in Austin, TX" docs/legal.md; then
            echo "âŒ Corporate entity missing from legal page"
            exit 1
          fi
          
          if ! grep -q "legal@zeropointprotocol.ai" docs/legal.md; then
            echo "âŒ Legal contact missing from legal page"
            exit 1
          fi
          
          # Check status page
          if [ -f "docs/status.md" ]; then
            if ! grep -q "Zeropoint Protocol, Inc., a Texas C Corporation with principal offices in Austin, TX" docs/status.md; then
              echo "âŒ Corporate entity missing from status page"
              exit 1
            fi
            
            if ! grep -q "legal@zeropointprotocol.ai" docs/status.md; then
              echo "âŒ Legal contact missing from status page"
              exit 1
            fi
          fi
          
          echo "âœ… Website documentation audit passed"
        else
          echo "â„¹ï¸ No website documentation found, skipping website audit"
        fi
        
    - name: Generate audit report
      run: |
        echo "ðŸ“Š Weekly Audit Report" > audit-report.txt
        echo "=====================" >> audit-report.txt
        echo "" >> audit-report.txt
        echo "Date: $(date)" >> audit-report.txt
        echo "Repository: ${{ github.repository }}" >> audit-report.txt
        echo "" >> audit-report.txt
        echo "âœ… LICENSE.md: Corporate entity, contact, and domain verified" >> audit-report.txt
        echo "âœ… Legal Documents: ZAA.md, CLA.md, CONTRIBUTING.md, LEGAL.md all present and consistent" >> audit-report.txt
        echo "âœ… README.md: License section properly formatted with corporate info" >> audit-report.txt
        echo "âœ… TypeScript Headers: All files have correct copyright headers" >> audit-report.txt
        
        if [ -f "docs/legal.md" ]; then
          echo "âœ… Website Documentation: Legal and status pages verified" >> audit-report.txt
        fi
        
        echo "" >> audit-report.txt
        echo "ðŸŽ‰ All compliance checks passed!" >> audit-report.txt
        
        cat audit-report.txt
